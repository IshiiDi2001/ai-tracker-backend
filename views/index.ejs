<!DOCTYPE html>
<html>
  <head>
    <title>AI Interaction Dashboard</title>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
      * {
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Arial, sans-serif;
        background: #f4f6f9;
        margin: 0;
        padding: 30px;
        color: #333;
      }

      h2,
      h3 {
        margin: 0;
      }

      h3 {
        margin-bottom: 15px;
      }

      /* Page container */
      .dashboard {
        max-width: 1300px;
        margin: auto;
        display: flex;
        flex-direction: column;
        gap: 30px;
      }

      /* Card */
      .card {
        background: #ffffff;
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
      }

      /* Header */
      .page-header {
        display: flex;
        align-items: center;
        gap: 14px;
      }

      .page-header img {
        width: 40px;
        height: 40px;
        border-radius: 8px;
        object-fit: cover;
      }

      .page-header h2 {
        margin: 0;
        font-size: 22px;
        font-weight: 600;
      }

      /* Table */
      table {
        width: 100%;
        border-collapse: collapse;
        font-size: 14px;
      }

      th,
      td {
        padding: 10px;
        border-bottom: 1px solid #e0e0e0;
        text-align: center;
      }

      th {
        background: #2c2c2c;
        color: #fff;
        font-weight: 600;
      }

      tr:hover {
        background-color: #f8f9fc;
      }

      th.category,
      td.category {
        width: 110px;
      }

      td.total-prompts {
        background-color: #f0f0f0;
        font-weight: bold;
      }

      /* Bottom layout */
      .bottom-section {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 30px;
      }

      /* Chart */
      .chart-container {
        width: 100%;
        height: 350px;
      }

      .button {
        padding: 10px 15px;
        background: #4caf50;
        border: none;
        color: white;
        border-radius: 5px;
        cursor: pointer;
        margin-bottom: 20px;
      }

      .button:hover {
        background: #43a047;
      }

      .chart-card {
        background: white;
        padding: 15px;
        margin-bottom: 25px;
        border-radius: 8px;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
        width: 350px;
      }

      .charts-container {
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
      }
    </style>
  </head>
  <body>
    <div class="dashboard">
      <div class="card page-header">
        <img src="/chatgpt.png" alt="ChatGPT Icon" />
        <h2>ChatGPT Usage Analytics</h2>
      </div>

      <!-- ================= SESSION-WISE TABLE ================= -->
      <div class="card">
        <table>
          <tr>
            <th>#</th>
            <th>User</th>
            <th>Session Start</th>
            <th>Session End</th>
            <th class="category">Idea Generation</th>
            <th class="category">Refinement</th>
            <th class="category">Information</th>
            <th class="category">Cognitive</th>
            <th class="category">Other</th>
            <th>Total Prompts</th>
          </tr>

          <% sessions.forEach((s, index) => { %>
          <tr>
            <td><%= index + 1 %></td>
            <td>User <%= s.userNo %></td>
            <td>
              <%= new Date(s.sessionStart).toLocaleString('en-US', { timeZone:
              'Asia/Kolkata' }) %>
            </td>
            <td>
              <%= new Date(s.sessionEnd).toLocaleString('en-US', { timeZone:
              'Asia/Kolkata' }) %>
            </td>
            <td class="category"><%= s.categories.IDEA_GENERATION || 0 %></td>
            <td class="category"><%= s.categories.REFINEMENT || 0 %></td>
            <td class="category"><%= s.categories.INFORMATION || 0 %></td>
            <td class="category"><%= s.categories.COGNITIVE || 0 %></td>
            <td class="category"><%= s.categories.OTHER || 0 %></td>
            <td class="total-prompts"><%= s.userCount %></td>
          </tr>
          <% }) %>
        </table>
      </div>

      <!-- Bottom Section -->
      <div class="bottom-section">
        <!-- Stats + Chart -->
        <div class="card">
          <h3>Total ChatGPT Usage Stats</h3>

          <p>
            <strong>Total User Messages:</strong>
            <span id="totalMessages"></span>
          </p>
          <div class="chart-container">
            <canvas id="totalPieChart"></canvas>
          </div>
        </div>

        <div class="card">
          <!-- ================= BUTTON ================= -->
          <button onclick="toggleCharts()">See Per-User Charts</button>
          <!-- ================= CHARTS (HIDDEN INITIALLY) ================= -->
          <div id="chartsSection" style="display: none">
            <div class="chart-container">
              <% users.forEach(u => { %>
              <div class="chart-card">
                <h3>User <%= u.userNo %></h3>
                <canvas id="chart-<%= u.userNo %>"></canvas>
              </div>
              <% }) %>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      const usersData = <%- JSON.stringify(users) %>;

      // ================= TOTAL CALCULATIONS =================
      const totalCategories = {
        IDEA_GENERATION: 0,
        REFINEMENT: 0,
        INFORMATION: 0,
        COGNITIVE: 0,
        OTHER: 0,
      };

      let totalMessages = 0;

      usersData.forEach(user => {
        totalMessages +=
          user.categories.IDEA_GENERATION +
          user.categories.REFINEMENT +
          user.categories.INFORMATION +
          user.categories.COGNITIVE +
          user.categories.OTHER;

        for (const key in totalCategories) {
          totalCategories[key] += user.categories[key];
        }
      });

      document.getElementById("totalMessages").innerText = totalMessages;

      // ================= TOTAL PIE CHART =================
      new Chart(document.getElementById("totalPieChart"), {
        type: "pie",
        data: {
          labels: [
            "Idea Generation",
            "Refinement",
            "Information",
            "Cognitive",
            "Other",
          ],
          datasets: [
            {
              data: [
                totalCategories.IDEA_GENERATION,
                totalCategories.REFINEMENT,
                totalCategories.INFORMATION,
                totalCategories.COGNITIVE,
                totalCategories.OTHER,
              ],
              backgroundColor: [
                "#4caf50",
                "#2196f3",
                "#ff9800",
                "#9c27b0",
                "#9e9e9e",
              ],
            },
          ],
        },
        options: {
          responsive: true,
          plugins: {
            legend: {
              position: "bottom",
            },
          },
        },
      });

          let chartsLoaded = false;

          function toggleCharts() {
            const section = document.getElementById("chartsSection");
            section.style.display =
              section.style.display === "none" ? "block" : "none";

            if (!chartsLoaded) {
              loadCharts();
              chartsLoaded = true;
            }
          }

          function loadCharts() {
            usersData.forEach(user => {
              new Chart(document.getElementById(`chart-${user.userNo}`), {
                type: "pie",
                data: {
                  labels: [
                    "Idea Generation",
                    "Refinement",
                    "Information",
                    "Cognitive",
                    "Other"
                  ],
                  datasets: [{
                    data: [
                      user.categories.IDEA_GENERATION,
                      user.categories.REFINEMENT,
                      user.categories.INFORMATION,
                      user.categories.COGNITIVE,
                      user.categories.OTHER
                    ],
                    backgroundColor: [
                      "#4caf50",
                      "#2196f3",
                      "#ff9800",
                      "#9c27b0",
                      "#9e9e9e"
                    ]
                  }]
                },
                options: {
                  responsive: true,
                  plugins: {
                    legend: {
                      position: "bottom"
                    }
                  }
                }
              });
            });
          }
    </script>
  </body>
</html>
