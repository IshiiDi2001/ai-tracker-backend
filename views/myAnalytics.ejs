<!DOCTYPE html>
<html>
  <head>
    <title>My Analytics</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
      * {
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Arial, sans-serif;
        background: #f4f6f9;
        margin: 0;
        padding: 30px;
        color: #333;
      }

      h2,
      h3 {
        margin: 0;
      }

      h3 {
        margin-bottom: 15px;
      }

      /* Page container */
      .dashboard {
        max-width: 1300px;
        margin: auto;
        display: flex;
        flex-direction: column;
        gap: 30px;
      }

      /* Card */
      .card {
        background: #ffffff;
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
      }

      /* Header */
      .page-header {
        display: flex;
        align-items: center;
        gap: 14px;
      }

      .page-header img {
        width: 40px;
        height: 40px;
        border-radius: 8px;
        object-fit: cover;
      }

      .page-header h2 {
        margin: 0;
        font-size: 22px;
        font-weight: 600;
      }

      /* Table */
      table {
        width: 100%;
        border-collapse: collapse;
        font-size: 14px;
      }

      th,
      td {
        padding: 10px;
        border-bottom: 1px solid #e0e0e0;
        text-align: center;
      }

      th {
        background: #2c2c2c;
        color: #fff;
        font-weight: 600;
      }

      tr:hover {
        background-color: #f8f9fc;
      }

      th.category,
      td.category {
        width: 110px;
      }

      td.total-prompts {
        background-color: #f0f0f0;
        font-weight: bold;
      }

      /* Bottom layout */
      .bottom-section {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 30px;
      }

      /* Stats */
      .total-stats div {
        display: flex;
        justify-content: space-between;
        padding: 6px 0;
        font-size: 14px;
      }

      .total-stats div strong {
        font-weight: 600;
      }

      /* Chart */
      .chart-container {
        width: 100%;
        height: 350px;
      }

      /* AI Suggestions */
      .ai-suggestions {
        background: #f1f8ff;
        border: 1px solid #d6e8ff;
        border-radius: 10px;
        padding: 20px;
      }

      #aiSuggestion {
        font-size: 14px;
        line-height: 1.6;
        white-space: pre-line;
      }

      /* Responsive */
      @media (max-width: 900px) {
        .bottom-section {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>

  <body>
    <div class="dashboard">
      <!-- Session Analytics -->
      <div class="card">
        <div class="card page-header">
          <img src="/chatgpt.png" alt="ChatGPT Icon" />
          <h2>Your ChatGPT Usage Analytics</h2>
        </div>
      </div>
      <div class="card">
        <h3>Your Session Analytics</h3>
        <table>
          <thead>
            <tr>
              <th>#</th>
              <th>Session Start</th>
              <th>Session End</th>
              <th class="category">Idea Generation</th>
              <th class="category">Refinement</th>
              <th class="category">Information</th>
              <th class="category">Cognitive</th>
              <th class="category">Other</th>
              <th>Total Prompts</th>
            </tr>
          </thead>
          <tbody>
            <% sessions.forEach((s, index) => { %>
            <tr>
              <td><%= index + 1 %></td>
              <td>
                <%= new Date(s.sessionStart).toLocaleString('en-US', { timeZone:
                'Asia/Kolkata' }) %>
              </td>
              <td>
                <%= new Date(s.sessionEnd).toLocaleString('en-US', { timeZone:
                'Asia/Kolkata' }) %>
              </td>
              <td class="category"><%= s.categories.IDEA_GENERATION || 0 %></td>
              <td class="category"><%= s.categories.REFINEMENT || 0 %></td>
              <td class="category"><%= s.categories.INFORMATION || 0 %></td>
              <td class="category"><%= s.categories.COGNITIVE || 0 %></td>
              <td class="category"><%= s.categories.OTHER || 0 %></td>
              <td class="total-prompts"><%= s.userCount %></td>
            </tr>
            <% }); %>
          </tbody>
        </table>
      </div>

      <!-- Bottom Section -->
      <div class="bottom-section">
        <!-- Stats + Chart -->
        <div class="card">
          <h3>Your Total ChatGPT Usage Stats</h3>

          <div class="total-stats">
            <div>
              <span>Total Messages Across All Sessions</span>
              <strong
                ><%= sessions.reduce((acc, s) => acc + s.userCount, 0)
                %></strong
              >
            </div>
            <div>
              <span>Idea Generation</span
              ><strong><%= totalCategories.IDEA_GENERATION %></strong>
            </div>
            <div>
              <span>Refinement</span
              ><strong><%= totalCategories.REFINEMENT %></strong>
            </div>
            <div>
              <span>Information</span
              ><strong><%= totalCategories.INFORMATION %></strong>
            </div>
            <div>
              <span>Cognitive</span
              ><strong><%= totalCategories.COGNITIVE %></strong>
            </div>
            <div>
              <span>Other</span><strong><%= totalCategories.OTHER %></strong>
            </div>
          </div>

          <div class="chart-container">
            <canvas id="pieChart"></canvas>
          </div>
        </div>

        <!-- AI Suggestions -->
        <div class="card ai-suggestions">
          <h3>Suggestions based on your usage (AI Powered)</h3>
          <div id="aiSuggestion">Loading suggestions...</div>
        </div>
      </div>
    </div>

    <script>
      const ctx = document.getElementById('pieChart').getContext('2d');
      const pieChart = new Chart(ctx, {
        type: 'pie',
        data: {
          labels: ['Idea Generation', 'Refinement', 'Information', 'Cognitive', 'Other'],
          datasets: [{
            data: [
              <%= totalCategories.IDEA_GENERATION %>,
              <%= totalCategories.REFINEMENT %>,
              <%= totalCategories.INFORMATION %>,
              <%= totalCategories.COGNITIVE %>,
              <%= totalCategories.OTHER %>
            ],
            backgroundColor: ['#4caf50','#2196f3','#ff9800','#9c27b0','#9e9e9e'],
          }]
        },
        options: {
          plugins: {
            legend: { position: 'bottom' },
            tooltip: { enabled: true }
          },
          maintainAspectRatio: false
        }
      });
    </script>

    <script>
      async function getAISuggestions() {
        const totals = {
          IDEA_GENERATION: <%= totalCategories.IDEA_GENERATION %>,
          REFINEMENT: <%= totalCategories.REFINEMENT %>,
          INFORMATION: <%= totalCategories.INFORMATION %>,
          COGNITIVE: <%= totalCategories.COGNITIVE %>,
          OTHER: <%= totalCategories.OTHER %>
        };


        const GROQ_API_KEY = "<%= groqApiKey %>";
        const GROQ_MODEL = "llama-3.1-8b-instant";
        const prompt = `
          You are an AI assistant. A user has the following ChatGPT usage stats:
          Idea Generation: ${totals.IDEA_GENERATION}
          Refinement: ${totals.REFINEMENT}
          Information: ${totals.INFORMATION}
          Cognitive: ${totals.COGNITIVE}
          Other: ${totals.OTHER}

          Guidelines for suggestions:
          - Focus on reducing over-dependence on ChatGPT for thinking.
          - Higher REFINEMENT usage is good and should be encouraged.
          - Higher INFORMATION usage is good and safe.
          - Higher COGNITIVE usage is not ideal and should be gently reduced.
          - Suggestions must be friendly, supportive, and user-focused.
          - Use phrases like "You have asked ChatGPT..." or "You tend to use ChatGPT..."
          - Do NOT sound judgmental or negative.

          Task:
          Based on these stats, and the guidelines above give 3 practical suggestions to improve or optimize the user's ChatGPT usage.
          Don't give suggestions about 'Other' category. Don't use user, instead use you.
          Respond in plain text as a numbered list. Don't add test styles like bold or * marks.
        `;

        try {
          const response = await fetch("https://api.groq.com/openai/v1/chat/completions", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "Authorization": `Bearer ${GROQ_API_KEY}`,
            },
            body: JSON.stringify({
              model: GROQ_MODEL,
              messages: [
                { role: "system", content: "You are an assistant providing usage suggestions." },
                { role: "user", content: prompt }
              ]
            })
          });

          const data = await response.json();
          const suggestion = data?.choices?.[0]?.message?.content || "No suggestions available.";
          document.getElementById("aiSuggestion").innerText = suggestion;
        } catch (err) {
          console.error("AI suggestion error:", err);
          document.getElementById("aiSuggestion").innerText = "Failed to load AI suggestions.";
        }
      }

      getAISuggestions();
    </script>
  </body>
</html>
